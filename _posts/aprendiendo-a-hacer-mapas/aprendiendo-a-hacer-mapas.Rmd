---
title: "Aprendiendo a hacer mapas"
description: |
  A short description of the post.
author:
  - name: Joshua Kunst
    url: http://jkunst.com/
date: 03-30-2019
output:
  distill::distill_article:
    self_contained: true
    toc: true
draft: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("_R/blog_setup.R"))
library(tidyverse)
```

<!--
La motivación de este post es un tweet de Juan Correa (Juanizio_C en twitter) en donde
nos muestra un gif. 

<blockquote class="twitter-tweet" data-lang="es"><p lang="es" dir="ltr">Una de las mayores expresiones de la desigualdad y segregación en Santiago ha sido el acceso a la educación<br><br>Entendiendo su rol como activo y movilizador social, es clave entender el gran retroceso de politicas como <a href="https://twitter.com/hashtag/AdmisionJusta?src=hash&amp;ref_src=twsrc%5Etfw">#AdmisionJusta</a> y el retorno de la selección escolar <a href="https://t.co/d87dMRqlGK">pic.twitter.com/d87dMRqlGK</a></p>&mdash; Juan Correa (@Juanizio_C) <a href="https://twitter.com/Juanizio_C/status/1091462602738286594?ref_src=twsrc%5Etfw">1 de febrero de 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

En las respuestas algunos usuarios, aparte de felicitarlo :), solicitan las imágenes 
por separado para mirarlas con más detalles. Estes es un problema usual de la animación
en donde uno debe recordar lo que ve para comparar con lo que esta actualmente viendo.

Por lo anterior intentaremos y aprenderemos acá:

- Aprender a graficar mapas
- Intentar replicar el output de Juanizio 
- Ver alternativas que no sean animadas pero igualmente atractivas
- Intentar hacerlo interactivo

-->

## Mapa

Para graficar el mapa de Santiago tomaremos los geojson  y los pasaremos
a Simple Feature.  

```{r, cache=TRUE}
library(tidyverse)

geourl <- "https://raw.githubusercontent.com/robsalasco/precenso_2016_geojson_chile/master/Zonas/R13.geojson"

zonas <- jsonlite::fromJSON(geourl)
zonas <- geojsonio::as.json(zonas)
zonas <- geojsonsf::geojson_sf(zonas)

glimpse(zonas)
```

Todo bien hasta ahora. Grafiquemos y exploremos el contenido del geojson.

```{r, cache=TRUE}
ggplot(zonas) +
  geom_sf(size = .2, fill = NA, colour = "gray80")
```

Vemos que hay zonas que estás dispersas. La verdad, al no ser experto en 
SIGs no se me ocurre otra forma mejor que obtener los centroides y filtrar
a mano.


```{r, cache=TRUE}
zonas <- zonas %>% 
  mutate(centro = sf::st_centroid(geometry))

centros_coords <- zonas %>% 
  pull(centro) %>% 
  sf::st_coordinates() 

zonas <- zonas %>% 
  mutate(
    x = centros_coords[, 1],
    y = centros_coords[, 2]
  )

zonas <- zonas %>% 
  filter(y <= -33.30) %>%
  filter(y >= -33.70) %>%
  filter(x >= -70.85) %>%
  filter(x <= -70.40)

ggplot(zonas) +
  geom_sf(size = .2, fill = "gray95", colour = "gray80") +
  coord_sf(ndiscr = 0) # https://stackoverflow.com/a/52426976/829971
```

No quedaron las mismas zonas que la versión original pero servirá
para nuestros propósitos.

## Datos

Acá debo enfatizar que no se mucho de representaciones geográficas y todas 
esas artes, ni menos el origen de datos y transformaciones se realizaron, así que
con todo el empeño intentaré obtener algo similar para que sigamos con el post

Leeremos la información desde un servidor que, nuevamente, Don Rob me ayudó a
levantar con los datos del CENSO, usaremos obviamente la tabla `personas`
pues contiene las respuesta de la pregunta sobre el grado alcanzado.

```{r}
con <- DBI::dbConnect(
  RMySQL::MySQL(),
  dbname = "censo2017",
  host = "142.93.20.188", 
  port = 3306,
  user = "test",
  password = "HFW9KYZBnEYr!"
)

DBI::dbListTables(con)

tbl(con, "idgeo") %>% 
  collect(n = 10) %>% 
  rmarkdown::paged_table()

tbl(con, "personas") %>% 
  collect(n = 10) %>% 
  rmarkdown::paged_table()
```

A la tabla filtraremos por `P07 = 1` que corresponden a los jefes de hogares,
y luego por la region metropolitana (`13`) y obtendremos los conteos de
cada respuesta segun región, provincia, comuna, dc, area, zc_loc.

<aside>
Mas detalles sobre los datos; https://redatam-ine.ine.cl/manuales/Manual-Usuario.pdf
</aside>

```{r, cache=TRUE}
dta_jefe_educ <- tbl(con, "personas") %>% 
  filter(P07 == 1) %>% 
  filter(REGION == 13) %>% 
  group_by(COMUNA, DC, AREA, ID_ZONA_LOC, ZC_LOC) %>% 
  count(P15, P15A) %>% 
  collect()

dta_jefe_educ <- dta_jefe_educ %>% 
  ungroup() %>% 
  mutate(
    P15_label = case_when(
      P15 %in% c(5, 6) & P15A == 1 ~ "Ed. Básica Completa",
      P15 %in% c(7:10) & P15A == 2 ~ "Ed. Media Incompleta",
      P15 %in% c(7:10) & P15A == 1 ~ "Ed. Media Completa",
      P15 == 11 ~ "Ed. Técnico Superior",
      P15 == 12 ~ "Ed. Superior",
      P15 %in% c(13, 14) ~ "Ed. Posgrado",
      TRUE ~ "Otra/Missing"
    )
  ) %>% 
  arrange(P15, P15A) %>% 
  mutate(P15_label = fct_inorder(P15_label))
```


```{r, layout="l-body"}
dta_jefe_educ %>% 
  count(P15_label) %>% 
  knitr::kable()
```


```{r}
dta_jefe_educ <- dta_jefe_educ %>% 
  group_by(COMUNA, DC, AREA, ID_ZONA_LOC, ZC_LOC) %>% 
  count(P15_label) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ungroup()
```


## Graficando los datos:

```{r, cache=TRUE}
dta_jefe_educ <- dta_jefe_educ %>%
  mutate(id = paste(
    COMUNA,
    sprintf("%02d", DC),
    AREA,
    sprintf("%03d", ZC_LOC),
    sep = ""
  ))

zonas <- zonas %>%
  mutate(
    AREA = 1, 
    id = paste(
    COMUNA,
    sprintf("%02d", COD_DIS),
    AREA,
    sprintf("%03d", COD_ZONA),
    sep = ""
  ))

dta_jefe_educ %>% count(nchar(id))
zonas         %>% count(nchar(id))


dta_jefe_educ %>% count(nchar(COMUNA))
zonas         %>% count(nchar(COMUNA))

dta_jefe_educ %>% count(nchar(DC))
zonas         %>% count(nchar(COD_DIS))

# dta_jefe_educ %>% count(nchar(ID_ZONA_LOC))
dta_jefe_educ %>% count(nchar(ZC_LOC))
zonas         %>% count(nchar(COD_ZONA))


zonas %>% 
  left_join(dta_jefe_educ %>% select(P15_label , porcentaje, id), by = "id") %>% 
  filter(!is.na(porcentaje)) %>%
  # filter(P15_label != "Otra/Missing") %>%
  # filter(P15_label == "Ed. Posgrado") %>%
  # filter(P15_label == "Ed. Básica Completa") %>%
  filter(porcentaje != 0) %>%
  mutate(porcentaje = cut(100*porcentaje, breaks = c(-Inf, 0, 20, 40, 60, Inf))) %>% 
  ggplot() +
  geom_sf(data = zonas, size = .2, fill = "gray95", colour = "gray80") +
  geom_sf(aes(fill = porcentaje), color = NA) +
  scale_fill_viridis_d(option = "B") +
  facet_wrap(vars(P15_label))
```


