---
title: "#30diasdegraficos Parte 2"
description: |
  La segunda parte, A seguir aprendiendo sobre todas las posibilidades que 
  highcharts a través de R nos puede brindar.
author:
  - name: Joshua Kunst
    url: http://jkunst.com/
date: "`r format(Sys.time(), '%m-%d-%Y')`"
output:
  distill::distill_article:
    self_contained: true
    toc: true
categories: 
  - spanish
  - highcharts
  - data-visualization
  - ggplot2
editor_options: 
  chunk_output_type: console
preview: images/preview.png
---


```{r setup, include=FALSE}
source(here::here("_R/blog_setup.R"))
knitr::opts_chunk$set(layout = "l-body-outset")
```

## Introducción

Seguiremos utilizando los mismos paquetes que la parte anterior.

```{r}
# ejecutar estas líneas para poder instalar {datos}
# install.packages("remotes")
# remotes::install_github("cienciadedatos/datos")

library(datos)       # datos
library(highcharter) # gráficos
library(ggplot2)     # más gráficos  
library(dplyr)       # manipulación de datos
library(tidyr)       # más manipulación de datos
```

Cambiando configuración para el español.

```{r}
newlang_opts <- getOption("highcharter.lang")

f <- Sys.Date()
dias <- weekdays((f - lubridate::days(lubridate::wday(f) - 1)) + lubridate::days(0:6))

newlang_opts$weekdays <- dias
newlang_opts$months <- as.character(lubridate::month(1:12, label = TRUE, abbr = FALSE))
newlang_opts$shortMonths <- as.character(lubridate::month(1:12, label = TRUE, abbr = TRUE))
newlang_opts$thousandsSep <- ","

options(highcharter.lang = newlang_opts)
```


## Día 11: mapas de calor

Mapa de calor. Usualmente se utiliza para visualizar relaciones entre dos
variables categorícas (o 2 contínuas categorizandolas). En este ejemplo
utilizaremos día y hora como una variables "numericas discretas". 

Caso de `heatmaps` son los visualizar distancia entre observaciones/individuos.

```{r}
mtautos2 <- mtautos[1:20, ]
matriz_distancias <- dist(mtautos2)

hchart(matriz_distancias) %>% 
  hc_title(text = "Distancia entre características de los vehículos")
```

Y también explorar correlaciones:

```{r}
hchart(cor(mtautos))
```

**Medio/Avanzado**. Es la implementación de este ejemplo 
https://www.highcharts.com/demo/heatmap-canvas. Notar la relación de 
opciones en HighchartsJS y {highcharter}.

```{r heatmap, layout="l-screen-inset"}
# install.packages("aimsir17")
library(lubridate)

data(observations, package = "aimsir17")

temperaturas <- observations %>% 
  filter(station == "KNOCK AIRPORT") %>% 
  select(fecha = date, hora = hour, temperatura = temp) %>% 
  mutate(fecha = as.Date(fecha))

# temperaturas %>% 
#   count(fecha, hora) %>% 
#   count(n)

hc11 <- hchart(
  temperaturas,
  "heatmap",
  hcaes(datetime_to_timestamp(fecha), hora, value = temperatura),
  colsize =  36e5 * 24 # 1 hour * 24 = 1 day
  ) %>%
  hc_title(text = "Temperaturas del aeropuerto Knock") %>%
  hc_subtitle(text = "Datos obtenidos del paquete {aimsir17}.") %>%
  hc_chart(zoomType = "x") %>%
  hc_xAxis(
    type = "datetime",
    title = list(text = FALSE)
    ) %>%
  hc_yAxis(
    minPadding = 0,
    maxPadding = 0,
    startOnTick = FALSE,
    endOnTick = FALSE,
    tickPositions = list(0, 6, 12, 18, 24),
    tickWidth = 1,
    min = 0,
    max = 23,
    reversed = TRUE,
    labels = list(format = "{value}:00"),
    title = list(text = FALSE)
  ) %>%
  hc_tooltip(
    headerFormat = "Temperatura<br/>",
    pointFormat =  "{point.x:%e %b, %Y} {point.y}:00: <b>{point.value} ℃</b>"
  ) %>%
  hc_colorAxis(
    stops = color_stops(10, colors = scales::viridis_pal(option = "B")(10)),
    # fuerza a utilzar mejor el espectro de colores para que HJS no amplie el
    # eje para tener numero "redondos
    startOnTick = FALSE,
    endOnTick =  FALSE
  ) %>%
  hc_legend(
    align = "right",
    layout = "vertical",
    verticalAlign = "top"
   )

hc11
```


## Día 12: paleta (lillipop)

Gráfico que se utiliza en forma general para describir una variable numérica
para un set de individuos/registros (a diferencia de gráfico de barra que 
usualmente se utiliza sumando cantidades por categoría).

Los datos a utilizar son `mtautos` del paquete {datos} pero pasando 
algunas variables a las métricas que usualemente en LA utilizamos: libras a kilos,
pulgadas cúbicas a centímeotrs cúbicos, etc.

```{r}
mtautos2 <- as_tibble(mtautos) %>% 
  mutate(auto = rownames(mtautos)) %>% 
  arrange(desc(caballos)) %>% 
  mutate(
    auto = forcats::fct_inorder(factor(auto)),
    peso_kg = round(0.4535923 * peso * 1000),
    cilindrada_cc = round(16.387 * cilindrada)
    ) 
  
mtautos2
```

La implementación en {highcharter} es directa, solamente usar el mapeo 
de `name` para la variable categórica y `low` para la numérica (`low` 
dado que esta es una modificación del gráfico de dumbbell que utiliza además
`high`).

**Basico/Medio**. En esta oportunidad haremos un tooltip de tipo tabla con
el fin de mostrar más información que los HP de cada vehículo. Para esto 
usaremos la función auxiliar `tooltip_table` en el argumento `pointFormat`.

```{r}
x <- c("Caballos:", "Peso", "Cilindrada")
y <- c(
  "{point.y} HP",
  "{point.peso_kg} kg",
  "{point.cilindrada_cc} cc"
)

hc12 <- hchart(mtautos2, "lollipop", hcaes(name = auto, low = caballos), name = "caballos (HP)") %>% 
  hc_xAxis(type = "category") %>% 
  hc_yAxis(labels = list(format = "{value} HP")) %>% 
  hc_tooltip(
    useHTML = TRUE,
    pointFormat = tooltip_table(x, y)
    ) %>% 
  hc_title(
    text = "Caballos de fuerza para autómóviles de Motor Trend"
  ) %>% 
  hc_subtitle(
    text = "Los datos fueron extraídos de la revista Motor Trend de Estados 
    Unidos de 1974, y tiene datos de consumo de combustible y 10 aspectos de diseño 
    y rendimiento para 32 automóviles (modelos de 1973-1974)."
  )

hc12
```

## Día 13: visualizar datos temporales

Notar que el último gráfico del [día 11](##día-11-mapas-de-calor) es un caso 
particular de de visualizar datos temporales.

Usualmente en **R** los datos temporales o serie de tiempo vienen en un 
objecto de clase `ts` (time series) que básicamente son valores numéricos
asociado a una fecha (o índice). Notar que también datos temporales pueden
perfectamente almacenarse en un `data.frame`, nota los datos `observations`
del [día 11](##día-11-mapas-de-calor). 

Para grafica objectos de clase `ts` en {highcharter} es bastante directo
dado que `hchart` es una **función genérica**. Esto significa que la
función dependiendo de la clase del objeto la interpretará/graficará de la 
forma que corresponde. Por ejemplo `ts` y `data.frame` son clases que la
función `hchart` reconoce, y existen muuuchas más clases que `hchart` puede
interpretar, intenta correr `methods("hchart") ` para listar todas las clases
que actualmente esta función soporta.

Volviendo a nuestro gráfico en **R** existe los datos `co2` que son una
serie de tiempo (clase `ts`).

```{r}
data(co2)

str(co2)

hchart(co2, name = "Concentración") %>% 
  hc_title(
    # para poder usar el tag html "sub" para subindices
    useHTML = TRUE,
    text = "Concentración atomsférica de CO<sub>2</sub> en Mauna Loa"
  ) %>% 
  hc_subtitle(
    text = "Las concentraciones atmosféricas de CO2 se expresan en partes por 
    millón (ppm) y se informan en la escala preliminar de fracción molar
    manométrica SIO de 1997."
  )
```

Aprovechando que estamos revisando series de tiempo, podemos hacer una
descomposición usando Loess (suavizamiento). La función `stl` toma un
serie de tiempo descomponiéndola en **tendencia**, **componente estacional** y
**ruido**.

Como veremos, el gráfico se realiza simplemente como `hchart(descomposicion)`:

```{r, }
descomposicion <- stl(co2, "per")

hchart(descomposicion) %>% 
  hc_tooltip(valueDecimals = 2) %>% 
  hc_title(
    useHTML = TRUE,
    text = "Descomposición de la Concentración atomsférica de CO<sub>2</sub> en
    Mauna Loa utilizando la funcion <code>stl</code>"
  ) %>% 
  hc_subtitle(
    text = "<b>Descripción del comando <code>stl</code></b>:
    El componente estacional se encuentra al suavizar loess la sub-serie
    estacional (la serie de todos los valores de enero, ...); si s.window = 
    'periódico' suavizado se reemplaza efectivamente tomando la media. Los 
    valores estacionales se eliminan y el resto se suaviza para encontrar la 
    tendencia. El nivel general se elimina del componente estacional y se agrega
    al componente de tendencia. Este proceso se repite varias veces. El componente
    restante son los residuos del ajuste estacional más tendencial."
  ) %>% 
  hc_size(height = "700px")
```

Para finalizar ejemplificaremos la integración de {highcharter} con el paquete
{forecast} con el cual se puede realizar predicciones de los datos de forma
simple.

```{r}
library(forecast)

pronosticos <- forecast(ets(USAccDeaths), h = 48, level = 95)

hchart(pronosticos) %>% 
  hc_title(
    text = "Muertes por accidentes en los EE. UU. 1973–1978 más predicciones
    generadas utilizando {forecast}"
  )
```



