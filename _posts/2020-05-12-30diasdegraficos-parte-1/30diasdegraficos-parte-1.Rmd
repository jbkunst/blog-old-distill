---
title: "#30diasdegraficos Parte 1"
description: |
  30 días de gráficos para compartir y aprender gracias a la inciativa de
  R4DS_es. Aprenderemos manipulación básica en R, highcharter y más!
author:
  - name: Joshua Kunst
    url: http://jkunst.com/
date: "`r format(Sys.time(), '%m-%d-%Y')`"
output:
  distill::distill_article:
    self_contained: true
    toc: true
categories: 
  - spanish
  - highcharts
  - data-visualization
  - ggplot2
editor_options: 
  chunk_output_type: console
preview: images/preview.jpg
---


```{r setup, include=FALSE}
source(here::here("_R/blog_setup.R"))
knitr::opts_chunk$set(layout = "l-body-outset")
```

## Introducción

Agradecer por la iniciativa a la comunidad de [R4DS_es](https://twitter.com/R4DS_es) <3:

```{r, echo=FALSE, fig.cap="30 días de gráficos! Yay!", out.extra="class=external"}
knitr::include_graphics("images/listado30graficosaldia.jpg")
```

Este post es muy espacial pues cumpl(e|irá|iría) muchas características.

- Será el primero en español en este blog! 
- Haré la mayoría de gráficos con el paquete [{highcharter}](http://jbkunst.com/highcharter), 
intentando ser lo más claro posible con el fin de que sirva también como 
introducción, casos de usos y ejemplos para el paquete. Partiremos de menos a más:
desde las funciones básicas, complementando luego con mejores práctivas y agregando
funcionalidades desde le mundo Javascript y HTML.
- También comentaremos usos y cuidados de cada uno de los tipos de gráficos para
que esto también sea termine siendo una ayuda al comenzar este viaje en el
mundo de la visualización. Dicho lo anterior intentaré ir siempre dando
link de material de ayuda a buenas fuentes de información.

Así que sin más, vamos a cargar los paquetes necesarios que en este caso 
serán {datos} para los data frames, {highcharter} y {ggplot2} para graficar
y {dplyr} para la manipulación de datos. Eventualmente utilizaremos otros 
paquetes como {lubridate} o {forcats} a medida que necesitemos de ellos.


```{r}
# ejecutar estas líneas para poder instalar {datos}
# install.packages("remotes")
# remotes::install_github("cienciadedatos/datos")

library(datos)       # datos
library(highcharter) # gráficos
library(ggplot2)     # más gráficos  
library(dplyr)       # manipulación de datos
```

## Día 1: barras/columnas

El gráfico más popular, quizás el más fácil de leer. Algunas consideraciones:

- Generalmente se utliza para visualizar conteos o cantidades agrupadas.
- No es recomendable usar muchas categorías. Obviamente dependerá del espacio
pero la idea es no generar tantas barras para seguir viendo las categorías

```{r}
conteo_clases <- count(millas, clase)
conteo_clases
```

Ahora teniendo listo del _data frame_, usaremos la función `hchart` del paquete
highcharter. La forma de utilizarlo es `hchart(dataframe, tipografico, hcaes(mapeo))`

De esta forma obtenemos nuestro gráfico interactivo con {highcharter}:

```{r}
hchart(conteo_clases, "column", hcaes(x = clase, y = n))
```

En un gráfico de barras usualmente se ordenan los conteos y siempre es bueno dar
más contexto a la visualización con un título y/o súbtítulo. 
Para lo primero reordenaremos  los registros de forma descente con la función y 
convertiremos la variable `clase` en un factor cuyos niveles estén ordenados 
según cantidad de vehículos. Para agregar el título usaremos la función 
`hc_title` usando el argumento `text`:


```{r}
library(forcats) # para usar la función fct_inorder

conteo_clases <- conteo_clases %>% 
  arrange(-n) %>% 
  mutate(clase = fct_inorder(clase))

hchart(conteo_clases, "column", hcaes(x = clase, y = n), name = "Conteo") %>% 
  hc_title(text = "Conteo de tipos de automóviles en los datos 'millas'")
```

## Día 2: líneas

Otro clásico. El gráfico de lineas se utiliza generalmente cuando existe una
variable temporal en nuestros datos. También tiene sus variaciones como los
slopecharts o bumpcharts.

Los datos que utilizaremos corresponden de paises del paquete {datos}, que 
orignalmente pertencen al {gapminder}. Para simplificar la información
agrouparemos por continente y año para obtener un promedio ponderado
por la población de cada país.

```{r}
continentes <- paises %>% 
  group_by(anio, continente) %>% 
  summarise(
    pib_per_capita_pond = weighted.mean(pib_per_capita, poblacion),
    esperanza_de_vida_pond = weighted.mean(esperanza_de_vida, poblacion)
  )

continentes
```

En esta oportunidad utilizaremos `group = continente` al realizar el mapeo para
separar los datos según esta variable.

```{r}
hc <- hchart(continentes, "line", hcaes(anio, esperanza_de_vida_pond, group = continente))
hc
```

¿Qué podemos mejora? ¡Mucho! Por ejemplo es dificil comparar para un mismo año,
los valores aparecen con muchos decimales, podemos mejorar las leyendas para 
que sea más fácil asociar las líneas, colores y continentes, para eso usaremos
la funciòn `hc_tooltip` para modificar el tooltip y `hc_legend` para mejorar
las leyendas

```{r}
hc %>% 
  hc_tooltip(table = TRUE, valueDecimals = 2) %>% 
  hc_legend(layout = "proximate")
```


## Día 3: puntos/burbujas

Seguimos con los gráficos tradicionales. El gráfico de puntos o scatter plot 
se utiliza generelamente para observa la relación entre dos variables 
continuas. Luego el gráfico se puede complementar/complejizar agregando tamaño,
forma, colores a los puntos para agregar más información.

```{r}
paises_2007 <- filter(paises, anio == 2007)
paises_2007
```

De la forma usual, utilizaremos la función `hchart`:

```{r}
hchart(paises_2007, "scatter", hcaes(pib_per_capita, esperanza_de_vida, group = continente))
```

Es un buen gráfico para patir ¿no? Ahora intentaremos:

- Agregar información de la población a través del tamaño del punto (mapeo!).
- Utilizar _captions_ para dar contexto o una explicación de lo que se puede observar.
Utilizaremos código _HTML_, esto es tags como: `<b></b>` para negrita `<i></i>` para
itálicas, `<br/>` para salto de línea, etc. existen muchos y nunca están de más conocerlos.
- Simplificar el tooltip indicando solamente el nombre del país, para esto
utilizaremos el argumento `pointFormat` en la función `hc_tooltip` dando como
valor `"{point.pais}"`: `{}` indica que será un valor dinámico (bien simplificado
este comentario), `point` siempre va pues se refiere al punto que el tooltip 
se está refiriendo, finalmente `pais` para señalar que utilizaremos esta
columna del data frame.
- Finalmente, cuando existen variables que son *asimétricas* -están cargadas 
hacia un lado- es bueno probar cambiando la escala del eje, en nuestro caso el
PIB. Acá será útil nuevamente el _caption_ para recordar que se está usando
escala logarítmica. Esto se hace con simplemente `hc_xAxis(type = "logarithmic")`.


```{r}
texto_explicativo <- "El gráfico nos muestra la relación entre el 
<b>PIB percápita</b> y la <b>Esperanza de vida</b> para países en el año 2007.
Se observa que la gran cantidad de paise con baja esperanza de vida pertenecen
al continente Africano de los cuales la mayoría posee bajo PIB per cápita.<br/>
Para <b>PIB percápita</b> se está utlizando una escala <i>logarítmica</i> debido
a la asimetría de esta variable."

hchart(
  paises_2007, 
  "scatter",
  hcaes(pib_per_capita, esperanza_de_vida, group = continente, z = poblacion),
  maxSize = 30 # para fijar y setar el tamaño máximo
  ) %>% 
  hc_tooltip(pointFormat = "{point.pais}") %>% 
  hc_caption(text = texto_explicativo) %>% 
  hc_title(text = "Relación entre PIB y Esperanza de vida") %>% 
  hc_xAxis(type = "logarithmic")
```

## Día 4: gráficos con facetas

Las facetas son una buena forma de _desaturar_ un gráfico con mucha información
visual crendo pequeños graficos particionando los datos. En este caso, no son 
muchos los paquetes o librería que manejan tan bien esta característica o 
funcionalidad como {ggplot2}. En el caso de {highcharter} esta funcionalidad
es limitada además manual, teniendo como solución realizar gráficos por separado
y luego mostrándolos todos juntos.

Siguiendo con {ggplot2}, esta se realiza _automágicamente_ con la función
`facet_wrap` (existe también `?facet_grid`) indicando por que variable partcionar
los datos. Un tip que veces se utiliza es
plotear todos los datos en cada faceta con un color suave con el fin de 
comparar la distribución o forma de los datos particulares de la faceta
con el total. Esto se hace agregando una capa (`geom`) del mismo tipo
con unos datos que no posean la variable para realizar las facetas; que 
en nuestro ejemplo es `Especies`:


```{r}
flores_auxiliar <- flores %>% 
  select(Largo.Sepalo, Ancho.Sepalo)

ggplot(flores) +
  geom_point(aes(Largo.Sepalo, Ancho.Sepalo), color = "gray90", data = flores_auxiliar, size = 1) +
  geom_point(aes(Largo.Sepalo, Ancho.Sepalo, color = Especies), size = 1.5) +
  scale_color_viridis_d(end = 0.8) +
  facet_wrap(vars(Especies)) +
  labs(title = "Distribución de Largo y Ancho de Sépalo según Especies")
```


**Medio/Avanzado**. Si quisiéramos realizar de todas formas con {highcharter}, 
una solución sería la siguiente: crear ejes 3 ejes, una para cada especies/grupo 
y luego asignar para cada grupo un eje.

```{r}
hchart(
  flores, 
  "scatter",
  hcaes(Largo.Sepalo, Ancho.Sepalo, group = Especies),
  yAxis = c(0, 1, 2) # parte clave para asignar cada grupo a cada eje Y
  ) %>% 
  # esta es la parte donde se crean *manualmente* 3 ejes.
  hc_yAxis_multiples(
    create_yaxis(
      naxis = 3,
      lineWidth = 2,
      title = purrr::map(0:2, ~list(text = "Ancho.Sepalo"))
      )
  ) %>% 
  hc_title(text = "Distribución de Largo y Ancho de Sépalo según Especies")
```



## Anexos

### Mapeo (mapping)

Mapeo o mapping se refiere a asociar una columna de una tabla a una característica
visual de un objeto. Por ejemplo para realizar un diagrama de puntos, uno debe
asociar la posiciòn vertical a una columna, y la posición horizontal a otra columna.
Quizás también asociar el tamaño en otra e incluso el color o forma. Más 
detalles en https://www.sharpsightlabs.com/blog/r-package-think-about-visualization/.

```{r, echo=FALSE, fig.cap="Ilustraciòn mapear", out.extra="class=external"}
knitr::include_graphics("images/4_bubble-chart_mapping-vars.png")
```

